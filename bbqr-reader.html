<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>BBQr Scanner</title>
  <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
  <link rel="shortcut icon" href="icon/favicon.ico">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'mono': ['SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Consolas', 'Courier New', 'monospace'],
          },
          animation: {
            'pulse-subtle': 'pulse 1.5s ease-in-out infinite',
          }
        }
      }
    }
  </script>
  
  <style>
    /* Custom styles for elements that need specific behavior */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-button-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .gradient-button-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .backdrop-blur-glass {
      backdrop-filter: blur(10px);
    }

    .file-type-badge {
      display: inline-block;
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .result-container {
      background: rgba(249, 250, 251, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(107, 114, 128, 0.1);
    }

    .camera-container {
      position: relative;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-900">
  <!-- Main Container -->
  <div class="max-w-md md:max-w-2xl mx-auto bg-white 
              rounded-t-3xl md:rounded-3xl md:my-5 lg:my-8 
              overflow-hidden min-h-screen md:min-h-0 md:shadow-xl">
    
    <!-- Header with Gradient Background -->
    <div class="gradient-bg text-white relative rounded-b-3xl 
                px-6 py-12 md:px-12 md:py-16 text-center">
      
      <!-- Top Handle (Mobile) -->
      <div class="absolute top-3 left-1/2 transform -translate-x-1/2 
                  w-9 h-1.5 bg-white/30 rounded-full md:hidden"></div>
      
      <!-- Back Link -->
      <a href="/" 
         class="absolute top-5 left-6 md:left-12 
                text-white/80 hover:text-white text-sm font-medium 
                flex items-center justify-center px-3 py-1.5 md:px-4 md:py-2 
                rounded-full bg-white/10 hover:bg-white/20 
                backdrop-blur-glass border border-white/20 
                transition-all duration-300 min-w-11 h-8 md:min-w-12 md:h-10"
         data-i18n="back">
        ‚Üê
      </a>
      

      
      <!-- Language Toggle -->
      <button class="language-toggle absolute top-5 right-6 md:right-12 
                     bg-white/10 hover:bg-white/20 border border-white/20 
                     rounded-full px-3 py-1.5 md:px-4 md:py-2 
                     text-white/80 hover:text-white text-sm font-medium 
                     cursor-pointer transition-all duration-300 
                     backdrop-blur-glass min-w-11 h-8 md:min-w-12 md:h-10 
                     flex items-center justify-center" 
              onclick="toggleLanguage()">
        ENG
      </button>
      
      <!-- Title -->
      <h1 class="text-3xl md:text-4xl font-bold mb-2 tracking-tight" data-i18n="title">
        BBQr Scanner
      </h1>
      <p class="text-white/85 text-sm md:text-base font-normal" data-i18n="subtitle">
        Bitcoin QR Code Scanning and Decoding
      </p>
    </div>
    
    <!-- Content -->
    <div class="p-6 md:p-12 bg-white space-y-6 md:space-y-8">
      
      <!-- Camera Scanning Section -->
      <div class="bg-white rounded-2xl md:rounded-3xl overflow-hidden
                  border border-gray-100 shadow-sm hover:shadow-md 
                  transition-all duration-300">
        <div class="p-6 md:p-8 pb-4">
          <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 tracking-tight" data-i18n="scanTitle">
            Scan BBQr Code
          </h2>
          
          <!-- Camera Controls -->
          <div class="text-center mb-6">
            <button 
              id="scan-btn"
              class="gradient-button-primary text-white px-8 py-4 
                     rounded-xl text-base font-semibold cursor-pointer 
                     transition-all duration-300 shadow-lg 
                     hover:-translate-y-0.5 hover:shadow-xl 
                     active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed 
                     disabled:transform-none disabled:shadow-lg"
              data-i18n="scanBtn">
              üì∑ Start Camera Scan
            </button>
          </div>
        </div>
        
        <!-- Full Screen Camera Container -->
        <div id="camera-container" class="relative hidden" style="height: 70vh; min-height: 400px;">
          <video 
            id="camera-video" 
            autoplay 
            playsinline 
            webkit-playsinline 
            muted
            class="w-full h-full object-cover bg-black">
          </video>
          
          <!-- Viewfinder Overlay -->
          <div class="absolute inset-0 pointer-events-none">
            <!-- Central viewfinder frame -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
                        w-64 h-64 md:w-80 md:h-80">
              <!-- Main frame -->
              <div class="w-full h-full border-4 border-white border-opacity-90 rounded-3xl shadow-lg"></div>
              
              <!-- Corner guides -->
              <div class="absolute -top-2 -left-2 w-10 h-10 border-l-4 border-t-4 border-yellow-400 rounded-tl-lg shadow-lg"></div>
              <div class="absolute -top-2 -right-2 w-10 h-10 border-r-4 border-t-4 border-yellow-400 rounded-tr-lg shadow-lg"></div>
              <div class="absolute -bottom-2 -left-2 w-10 h-10 border-l-4 border-b-4 border-yellow-400 rounded-bl-lg shadow-lg"></div>
              <div class="absolute -bottom-2 -right-2 w-10 h-10 border-r-4 border-b-4 border-yellow-400 rounded-br-lg shadow-lg"></div>
              
              <!-- Center crosshair -->
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <div class="w-8 h-1 bg-red-400 shadow-lg absolute -left-4 top-0 rounded-full"></div>
                <div class="w-1 h-8 bg-red-400 shadow-lg absolute left-0 -top-4 rounded-full"></div>
              </div>
              
              <!-- Scanning animation -->
              <div class="absolute inset-0 rounded-3xl overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent 
                           animate-pulse opacity-70"></div>
              </div>
            </div>
            
            <!-- Stop button overlay - top right -->
            <button 
              id="stop-scan-btn"
              class="absolute top-6 right-6 bg-red-600 hover:bg-red-700 text-white 
                     px-4 py-2 rounded-full text-sm font-semibold cursor-pointer 
                     transition-all duration-300 shadow-lg 
                     active:scale-95 backdrop-blur-sm hidden z-20"
              data-i18n="stopScanBtn">
              ‚èπÔ∏è ÂÅúÊ≠¢
            </button>
            
            <!-- Status overlay - top center, below stop button -->
            <div id="scan-status" class="absolute top-16 left-1/2 transform -translate-x-1/2 
                                      bg-black bg-opacity-90 text-white px-6 py-4 rounded-2xl 
                                      text-center font-medium backdrop-blur-sm shadow-lg
                                      max-w-sm text-sm leading-relaxed z-10">
              ÂáÜÂ§áÂºÄÂßãÊâ´Êèè...
            </div>
          </div>
        </div>
        
        <!-- Canvas for Camera -->
        <canvas id="camera-canvas" class="hidden"></canvas>
      </div>



      <!-- Results Section -->
      <div class="bg-white rounded-2xl md:rounded-3xl p-6 md:p-8 
                  border border-gray-100 shadow-sm hover:shadow-md 
                  transition-all duration-300">
        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 tracking-tight" data-i18n="resultsTitle">
          Decode Results
        </h2>
        
        <!-- PSBT Raw Data Display -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3" data-i18n="rawDataTitle">
            Raw PSBT Data
          </h3>
          <div 
            id="decode-output"
            class="result-container p-6 rounded-xl 
                   whitespace-pre-wrap break-all font-mono text-sm leading-relaxed 
                   min-h-32 hidden">
          </div>
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="text-center text-gray-500 py-8">
          <div class="text-4xl mb-4">üì±</div>
          <p data-i18n="noResults">No results yet. Start scanning to decode BBQr codes.</p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-col md:flex-row gap-3 md:gap-4 mt-6 hidden" id="result-actions">
          <button 
            id="copy-btn"
            class="gradient-button-success text-white px-6 py-3 md:px-8 md:py-4 
                   rounded-xl text-base font-semibold cursor-pointer 
                   transition-all duration-300 shadow-lg 
                   hover:-translate-y-0.5 hover:shadow-xl 
                   active:translate-y-0 flex-1"
            data-i18n="copyBtn">
            üìã Copy Result
          </button>
          
          <button 
            id="clear-btn"
            class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-6 py-3 md:px-8 md:py-4 
                   rounded-xl text-base font-semibold cursor-pointer 
                   transition-all duration-300 shadow-lg 
                   hover:-translate-y-0.5 hover:shadow-xl 
                   active:translate-y-0 flex-1"
            data-i18n="clearBtn">
            üóëÔ∏è Clear Results
          </button>
        </div>
      </div>

      <!-- PSBT Decoder Section -->
      <div class="bg-white rounded-2xl md:rounded-3xl p-6 md:p-8 
                  border border-gray-100 shadow-sm hover:shadow-md 
                  transition-all duration-300">
        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 tracking-tight" data-i18n="psbtDecoderTitle">
          PSBT Decoder
        </h2>
        
        <!-- PSBT Input Area -->
        <div class="mb-6">
          <label for="psbt-input" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="psbtInputLabel">
            Enter PSBT (Base64)
          </label>
          
          <!-- File Upload Section -->
          <div class="mb-4">
            <div class="flex items-center justify-center w-full">
              <label for="psbt-file-input" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors duration-300">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                  </svg>
                  <p class="mb-2 text-sm text-gray-500">
                    <span class="font-semibold" data-i18n="uploadFileText">Click to upload PSBT file</span>
                  </p>
                  <p class="text-xs text-gray-500" data-i18n="supportedFormats">TXT, PSBT files supported</p>
                </div>
                <input id="psbt-file-input" type="file" class="hidden" accept=".txt,.psbt,.dat" />
              </label>
            </div>
            
            <!-- File Info Display -->
            <div id="file-info" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <div class="flex items-center">
                <svg class="w-4 h-4 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                </svg>
                <span id="file-name" class="text-sm font-medium text-blue-800"></span>
                <span id="file-size" class="text-sm text-blue-600 ml-2"></span>
              </div>
            </div>
          </div>
          
          <!-- Manual Input -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-2" data-i18n="manualInputLabel">
              Or enter manually:
            </label>
            <textarea 
              id="psbt-input"
              class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                     font-mono text-sm resize-y min-h-32"
              placeholder="Enter PSBT in Base64 format..."
              data-i18n-placeholder="psbtInputPlaceholder">
            </textarea>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-3">
            <button 
              id="decode-psbt-btn"
              class="gradient-button-primary text-white px-6 py-3 
                     rounded-xl text-base font-semibold cursor-pointer 
                     transition-all duration-300 shadow-lg 
                     hover:-translate-y-0.5 hover:shadow-xl 
                     active:translate-y-0 flex-1"
              data-i18n="decodePsbtBtn">
              üîç Decode PSBT
            </button>
            
            <button 
              id="clear-psbt-btn"
              class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-6 py-3 
                     rounded-xl text-base font-semibold cursor-pointer 
                     transition-all duration-300 shadow-lg 
                     hover:-translate-y-0.5 hover:shadow-xl 
                     active:translate-y-0"
              data-i18n="clearPsbtBtn">
              üóëÔ∏è Clear
            </button>
          </div>
        </div>
        
        <!-- PSBT Analysis Results -->
        <div id="psbt-analysis" class="hidden">
          <h3 class="text-lg font-semibold text-gray-800 mb-4" data-i18n="psbtAnalysisTitle">
            Transaction Analysis
          </h3>
          
          <!-- Simplified Transaction Info -->
          <div class="space-y-4 mb-6">
            <!-- Signature Status -->
            <div class="bg-gray-50 p-4 rounded-xl">
              <div class="text-sm font-medium text-gray-600 mb-2" data-i18n="signStatusLabel">Signature Status</div>
              <div id="sign-status" class="text-base font-semibold">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                  -
                </span>
              </div>
            </div>
            
            <!-- Transaction Fee Info -->
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl">
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm font-medium text-blue-800 mb-1" data-i18n="feeLabel">Transaction Fee</div>
                  <div id="tx-fee" class="text-lg font-bold text-blue-900">-</div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-blue-800 mb-1" data-i18n="feeRateLabel">Fee Rate</div>
                  <div id="fee-rate" class="text-lg font-bold text-blue-900">-</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Payment Addresses Section -->
          <div class="mb-6">
            <h4 class="text-md font-semibold text-gray-800 mb-3" data-i18n="paymentsTitle">Payment Addresses</h4>
            <div id="payments-list" class="space-y-3">
              <!-- Payment addresses will be dynamically populated -->
            </div>
          </div>

          <!-- Finalize Section -->
          <div class="border-t pt-6">
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
              <button 
                id="finalize-psbt-btn"
                class="gradient-button-primary text-white px-6 py-3 
                       rounded-xl text-base font-semibold cursor-pointer 
                       transition-all duration-300 shadow-lg 
                       hover:-translate-y-0.5 hover:shadow-xl 
                       active:translate-y-0 flex-1"
                data-i18n="finalizePsbtBtn">
                üî® Finalize Transaction
              </button>
            </div>
            
            <!-- Finalized Transaction Result -->
            <div id="finalized-hex-container" class="hidden">
              <h4 class="text-md font-semibold text-gray-800 mb-4" data-i18n="finalizedHexTitle">Finalized Transaction</h4>
              
              <!-- Transaction ID Section -->
              <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                <div class="text-sm font-medium text-green-800 mb-2" data-i18n="txidLabel">Transaction ID (TXID)</div>
                <div class="bg-white border border-green-200 rounded-lg p-3">
                  <div id="transaction-txid" class="font-mono text-sm text-gray-900 break-all select-all"></div>
                </div>
                <div class="flex gap-2 mt-3">
                  <button 
                    id="copy-txid-btn"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 
                           rounded-lg text-sm font-medium transition-colors duration-200"
                    data-i18n="copyTxidBtn">
                    üìã Copy TXID
                  </button>
                  <div id="tx-size" class="flex items-center text-sm text-gray-600">
                    <!-- Size info will be displayed here -->
                  </div>
                </div>
              </div>

              <!-- Transaction Hex Section -->
              <div class="bg-gray-50 border border-gray-300 rounded-xl p-4">
                <div class="text-sm font-medium text-gray-700 mb-2" data-i18n="hexDescription">Raw Transaction (Ready to broadcast):</div>
                <textarea 
                  id="finalized-hex" 
                  readonly
                  class="w-full h-32 p-3 border border-gray-200 rounded-lg font-mono text-sm bg-white resize-none"
                  placeholder="Finalized transaction hex will appear here...">
                </textarea>
                <div class="flex gap-2 mt-3">
                  <button 
                    id="copy-hex-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 
                           rounded-lg text-sm font-medium transition-colors duration-200"
                    data-i18n="copyHexBtn">
                    üìã Copy Hex
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- PSBT Decode Error -->
        <div id="psbt-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
          <div class="flex items-center">
            <div class="text-red-400 mr-3">‚ö†Ô∏è</div>
            <div class="text-red-800 font-medium" data-i18n="psbtErrorTitle">PSBT Decode Error</div>
          </div>
          <div id="psbt-error-message" class="text-red-700 text-sm mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="./dist/bbqr-reader.bundle.js"></script>
  <script src="./dist/psbt-decoder.bundle.js"></script>
  
  <script>
    // Language support
    const translations = {
      en: {
        title: 'BBQr Scanner',
        subtitle: 'Bitcoin QR Code Scanning and Decoding',
        back: '‚Üê',
        scanTitle: 'Scan BBQr Code',
        scanBtn: 'üì∑ Start Camera Scan',
        stopScanBtn: '‚èπÔ∏è Stop Scanning',
        resultsTitle: 'Decode Results',
        rawDataTitle: 'Raw PSBT Data',
        noResults: 'No results yet. Start scanning to decode BBQr codes.',
        copyBtn: 'üìã Copy Result',
        clearBtn: 'üóëÔ∏è Clear Results',
        psbtDecoderTitle: 'PSBT Decoder',
        psbtInputLabel: 'Enter PSBT (Base64)',
        uploadFileText: 'Click to upload PSBT file',
        supportedFormats: 'TXT, PSBT files supported',
        manualInputLabel: 'Or enter manually:',
        psbtInputPlaceholder: 'Enter PSBT in Base64 format...',
        decodePsbtBtn: 'üîç Decode PSBT',
        clearPsbtBtn: 'üóëÔ∏è Clear',
        psbtAnalysisTitle: 'Transaction Analysis',
        signStatusLabel: 'Signature Status',
        feeLabel: 'Transaction Fee',
        feeRateLabel: 'Fee Rate',
        paymentsTitle: 'Payment Addresses',
        finalizePsbtBtn: 'üî® Finalize Transaction',
        finalizedHexTitle: 'Finalized Transaction',
        txidLabel: 'Transaction ID (TXID)',
        copyTxidBtn: 'üìã Copy TXID',
        hexDescription: 'Raw Transaction (Ready to broadcast):',
        copyHexBtn: 'üìã Copy Hex',
        psbtErrorTitle: 'PSBT Decode Error',
        fileReadError: 'Error reading file.'
      },
      zh: {
        title: 'BBQr Êâ´ÊèèÂô®',
        subtitle: 'ÊØîÁâπÂ∏Å QR Á†ÅÊâ´ÊèèÂíåËß£Á†Å',
        back: '‚Üê',
        scanTitle: 'Êâ´Êèè BBQr Á†Å',
        scanBtn: 'üì∑ ÂºÄÂßãÁõ∏Êú∫Êâ´Êèè',
        stopScanBtn: '‚èπÔ∏è ÂÅúÊ≠¢Êâ´Êèè',
        resultsTitle: 'Ëß£Á†ÅÁªìÊûú',
        rawDataTitle: 'ÂéüÂßã PSBT Êï∞ÊçÆ',
        noResults: 'ÊöÇÊó†ÁªìÊûú„ÄÇÂºÄÂßãÊâ´ÊèèÊù•Ëß£Á†Å BBQr Á†Å„ÄÇ',
        copyBtn: 'üìã Â§çÂà∂ÁªìÊûú',
        clearBtn: 'üóëÔ∏èÊ∏ÖÈô§ÁªìÊûú',
        psbtDecoderTitle: 'PSBT Ëß£Á†ÅÂô®',
        psbtInputLabel: 'ËæìÂÖ• PSBT (Base64)',
        uploadFileText: 'ÁÇπÂáª‰∏ä‰º† PSBT Êñá‰ª∂',
        supportedFormats: 'ÊîØÊåÅ TXT, PSBT Êñá‰ª∂',
        manualInputLabel: 'ÊàñÊâãÂä®ËæìÂÖ•Ôºö',
        psbtInputPlaceholder: 'ËæìÂÖ• Base64 Ê†ºÂºèÁöÑ PSBT...',
        decodePsbtBtn: 'üîç Ëß£Á†Å PSBT',
        clearPsbtBtn: 'üóëÔ∏è Ê∏ÖÈô§',
        psbtAnalysisTitle: '‰∫§ÊòìÂàÜÊûê',
        signStatusLabel: 'Á≠æÂêçÁä∂ÊÄÅ',
        feeLabel: '‰∫§ÊòìË¥π',
        feeRateLabel: 'Ë¥πÁéá',
        paymentsTitle: 'ÊîØ‰ªòÂú∞ÂùÄ',
        finalizePsbtBtn: 'üî® ÂÆåÊàê‰∫§Êòì',
        finalizedHexTitle: 'ÊúÄÁªà‰∫§Êòì',
        txidLabel: '‰∫§ÊòìID (TXID)',
        copyTxidBtn: 'üìã Â§çÂà∂TXID',
        hexDescription: 'ÂéüÂßã‰∫§Êòì (ÂèØÂπøÊí≠):',
        copyHexBtn: 'üìã Â§çÂà∂ÂçÅÂÖ≠ËøõÂà∂',
        psbtErrorTitle: 'PSBT Ëß£Á†ÅÈîôËØØ',
        fileReadError: 'ËØªÂèñÊñá‰ª∂ÈîôËØØ„ÄÇ'
      }
    };

    let currentLanguage = localStorage.getItem('language') || 'en';

    function updateTexts() {
      const texts = translations[currentLanguage];
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (texts[key]) {
          element.textContent = texts[key];
        }
      });

      // Handle placeholder translations
      document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (texts[key]) {
          element.placeholder = texts[key];
        }
      });

      const toggleBtn = document.querySelector('.language-toggle');
      if (toggleBtn) {
        toggleBtn.textContent = currentLanguage === 'en' ? '‰∏≠Êñá' : 'ENG';
      }

      document.documentElement.lang = currentLanguage;
    }

    function toggleLanguage() {
      currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
      localStorage.setItem('language', currentLanguage);
      updateTexts();
    }

    // Initialize language on page load
    updateTexts();

    // PSBT Decoding functionality using local modules
    function decodePSBT(psbtBase64) {
      try {
        // Check if psbt decoder is available
        if (typeof window.psbtDecoder === 'undefined') {
          throw new Error('PSBT decoder not loaded. Please ensure the module is included.');
        }

        return window.psbtDecoder.decodePSBT(psbtBase64);
      } catch (error) {
        console.error('PSBT decode error:', error);
        throw new Error('Failed to decode PSBT: ' + error.message);
      }
    }

    function formatBitcoinAmount(satoshis) {
      if (typeof window.psbtDecoder !== 'undefined') {
        return window.psbtDecoder.formatBitcoinAmount(satoshis);
      }
      // Fallback implementation
      const btc = parseInt(satoshis) / 100000000;
      return `${btc.toFixed(8)} BTC (${parseInt(satoshis).toLocaleString()} sats)`;
    }

    function displayPSBTAnalysis(analysis) {
      const analysisDiv = document.getElementById('psbt-analysis');
      const errorDiv = document.getElementById('psbt-error');
      
      errorDiv.classList.add('hidden');
      analysisDiv.classList.remove('hidden');

      // Update signature status
      const signStatus = document.getElementById('sign-status');
      const statusSpan = signStatus.querySelector('span');
      
      let statusText = analysis.signatureStatus;
      let statusClass = '';
      
      if (analysis.signatureStatus === 'Fully Signed') {
        statusText = currentLanguage === 'en' ? 'Fully Signed' : 'ÂÆåÂÖ®Á≠æÂêç';
        statusClass = 'bg-green-100 text-green-800';
      } else if (analysis.signatureStatus === 'Partially Signed') {
        statusText = currentLanguage === 'en' ? 'Partially Signed' : 'ÈÉ®ÂàÜÁ≠æÂêç';
        statusClass = 'bg-orange-100 text-orange-800';
      } else {
        statusText = currentLanguage === 'en' ? 'Unsigned' : 'Êú™Á≠æÂêç';
        statusClass = 'bg-yellow-100 text-yellow-800';
      }
      
      statusSpan.textContent = statusText;
      statusSpan.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}`;

      // Update fee information
      document.getElementById('tx-fee').textContent = formatBitcoinAmount(analysis.fee);
      
      // Calculate and display fee rate (approximate)
      const feeRate = analysis.fee > 0 ? (parseInt(analysis.fee) / 250).toFixed(1) : '0'; // Rough estimate
      document.getElementById('fee-rate').textContent = `${feeRate} sat/vB`;

      // Update payment addresses (only payment outputs, not change)
      const paymentsList = document.getElementById('payments-list');
      paymentsList.innerHTML = '';
      
      analysis.outputs.forEach((output, index) => {
        const paymentDiv = document.createElement('div');
        paymentDiv.className = 'bg-green-50 border border-green-200 rounded-xl p-4';
        paymentDiv.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="text-sm font-medium text-green-800">${currentLanguage === 'en' ? 'Payment' : 'ÊîØ‰ªò'} ${index + 1}</div>
            <div class="text-lg font-bold text-green-900">${formatBitcoinAmount(output.amount)}</div>
          </div>
          <div class="text-sm text-gray-600 mb-1">${currentLanguage === 'en' ? 'To Address' : 'Êî∂Ê¨æÂú∞ÂùÄ'}:</div>
          <div class="font-mono text-sm text-gray-900 break-all bg-white p-2 rounded border">${output.address}</div>
        `;
        paymentsList.appendChild(paymentDiv);
      });
    }

    function showPSBTError(message) {
      const analysisDiv = document.getElementById('psbt-analysis');
      const errorDiv = document.getElementById('psbt-error');
      const errorMessage = document.getElementById('psbt-error-message');
      
      analysisDiv.classList.add('hidden');
      errorDiv.classList.remove('hidden');
      errorMessage.textContent = message;
    }

    // Initialize BBQr Reader functionality when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // The actual BBQr scanning logic will be loaded from bbqr.bundle.js
      // We'll create a separate reader-specific initialization
      if (window.initBBQrReader) {
        window.initBBQrReader();
      }

      // Setup PSBT decoder functionality
      const decodePsbtBtn = document.getElementById('decode-psbt-btn');
      const clearPsbtBtn = document.getElementById('clear-psbt-btn');
      const psbtInput = document.getElementById('psbt-input');
      const psbtFileInput = document.getElementById('psbt-file-input');
      const fileInfo = document.getElementById('file-info');
      const fileName = document.getElementById('file-name');
      const fileSize = document.getElementById('file-size');
      const finalizePsbtBtn = document.getElementById('finalize-psbt-btn');
      const copyHexBtn = document.getElementById('copy-hex-btn');
      const copyTxidBtn = document.getElementById('copy-txid-btn');
      const finalizedHexContainer = document.getElementById('finalized-hex-container');
      const finalizedHex = document.getElementById('finalized-hex');
      const transactionTxid = document.getElementById('transaction-txid');
      const txSize = document.getElementById('tx-size');

      // File upload handler
      psbtFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
        fileInfo.classList.remove('hidden');

        // Read file content
        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          psbtInput.value = content.trim();
        };
        reader.onerror = () => {
          showPSBTError(translations[currentLanguage].fileReadError);
          fileInfo.classList.add('hidden');
        };
        reader.readAsText(file);
      });

      // Clear function
      function clearPSBTInput() {
        psbtInput.value = '';
        psbtFileInput.value = '';
        fileInfo.classList.add('hidden');
        document.getElementById('psbt-analysis').classList.add('hidden');
        document.getElementById('psbt-error').classList.add('hidden');
        finalizedHexContainer.classList.add('hidden');
        finalizedHex.value = '';
        transactionTxid.textContent = '';
        txSize.textContent = '';
        window.currentPsbtData = null;
      }

      // Clear button handler
      clearPsbtBtn.addEventListener('click', clearPSBTInput);

      // Decode button handler
      decodePsbtBtn.addEventListener('click', () => {
        const psbtData = psbtInput.value.trim();
        if (!psbtData) {
          showPSBTError(currentLanguage === 'en' ? 'Please enter a PSBT to decode or upload a file.' : 'ËØ∑ËæìÂÖ•Ë¶ÅËß£Á†ÅÁöÑ PSBT Êàñ‰∏ä‰º†Êñá‰ª∂„ÄÇ');
          return;
        }

        try {
          const analysis = decodePSBT(psbtData);
          
          // Store current PSBT data for finalization
          window.currentPsbtData = psbtData;
          
          displayPSBTAnalysis(analysis);
        } catch (error) {
          console.error('PSBT decode error:', error);
          showPSBTError(error.message);
        }
      });

      // Finalize PSBT button handler
      finalizePsbtBtn.addEventListener('click', () => {
        if (!window.currentPsbtData) {
          showPSBTError(currentLanguage === 'en' ? 'Please decode a PSBT first.' : 'ËØ∑ÂÖàËß£Á†Å‰∏Ä‰∏™ PSBT„ÄÇ');
          return;
        }

        try {
          // Check if finalize function is available
          if (typeof window.psbtDecoder === 'undefined' || !window.psbtDecoder.finalizePSBT) {
            throw new Error('PSBT finalize function not available');
          }

          const result = window.psbtDecoder.finalizePSBT(window.currentPsbtData);
          
          if (result.success) {
            
            // Display TXID prominently
            transactionTxid.textContent = result.txid;
            
            // Display transaction hex
            finalizedHex.value = result.hex;
            
            // Display transaction size
            txSize.textContent = `${result.size} bytes`;
            
            // Show the finalized result container
            finalizedHexContainer.classList.remove('hidden');
          } else {
            throw new Error(result.error);
          }
          
        } catch (error) {
          console.error('PSBT finalization error:', error);
          showPSBTError(currentLanguage === 'en' ? 
            'Finalization failed: ' + error.message : 
            'ÂÆåÊàêÂ§±Ë¥•Ôºö' + error.message);
        }
      });

      // Copy TXID button handler
      copyTxidBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(transactionTxid.textContent);
          
          // Visual feedback
          const originalText = copyTxidBtn.textContent;
          copyTxidBtn.textContent = currentLanguage === 'en' ? '‚úÖ Copied!' : '‚úÖ Â∑≤Â§çÂà∂ÔºÅ';
          setTimeout(() => {
            copyTxidBtn.textContent = originalText;
          }, 2000);
          
        } catch (error) {
          console.error('Failed to copy TXID:', error);
          // Fallback: select the text for manual copy
          const range = document.createRange();
          range.selectNode(transactionTxid);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
        }
      });

      // Copy hex button handler
      copyHexBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(finalizedHex.value);
          
          // Visual feedback
          const originalText = copyHexBtn.textContent;
          copyHexBtn.textContent = currentLanguage === 'en' ? '‚úÖ Copied!' : '‚úÖ Â∑≤Â§çÂà∂ÔºÅ';
          setTimeout(() => {
            copyHexBtn.textContent = originalText;
          }, 2000);
          
        } catch (error) {
          console.error('Failed to copy hex:', error);
          // Fallback for older browsers
          finalizedHex.select();
          document.execCommand('copy');
        }
      });

      // Auto-fill PSBT input when BBQr result is available
      const originalScanSuccess = window.onBBQrScanSuccess;
      window.onBBQrScanSuccess = function(data) {
        if (originalScanSuccess) {
          originalScanSuccess(data);
        }
        
        // If the decoded data looks like a PSBT, auto-fill the decoder
        if (data && typeof data === 'string' && data.startsWith('cHNidP8')) {
          psbtInput.value = data;
        }
      };
    });
  </script>
</body>
</html>
